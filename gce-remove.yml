---
- name: Remove Instance
  hosts: localhost
  connection: local
  strategy: free

  vars:
    service_account: "{{ lookup('file', credentials_file) }}"
    ssh_private_key: "{{ service_account['private_key'] }}"
    project_id: "{{ service_account['project_id'] }}"
    service_account_email: "{{ service_account['client_email'] }}"

  vars_files:
  - gce-properties.yml

  tasks:
  - name: Remove instance
    gce:
      instance_names: "{{ item }}"
      zone: "{{ zone }}"
      project_id: "{{ project_id }}"
      service_account_email: "{{ service_account_email }}"
      credentials_file: '{{ credentials_file }}'
      state: deleted
    with_items: "{{ instance_names | split(',') }}"
    async: 45
    poll: 0

